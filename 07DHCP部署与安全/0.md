## DHCP部署与安全

### DHCP作用

自动分配IP

### DHCP相关概念

1. 地址池／作用域：（IP、子网掩码、网关、DNS、租期）

2. DHCP协议端口是UDP 67/68

### DHCP优点

减少工作量,避免IP冲突,提高地址利用率

### DHCP原理

也称为DHCP租约过程,分为四个步骤:

1. 发送DHCP Discovery 广播包

   客户机广播请求IP地址(包含客户机的MAC地址)

2. 响应DHCP Offer广播包

   服务器响应提供的IP地址(但无子网掩码,网关等参数)

3. 客户机发送DHCP Request广播包

   客户机选择IP(也可认为是使用哪个IP)

4. 服务器发送DHCP ACK广播包

   服务器确定了租约,并提供网卡的详细参数IP, 掩码, 网关, DNS, 租期等

### DHCP续约

当50%过后, 客户机会再次发送DHCP Request包, 进行续约, 如服务器无响应, 则继续使用并在87.5%再次发送DHCP Request包,进行续约,如仍然无响应,并释放IP地址,及重新发送DHCP Discovery广播包来获取IP地址.当无任何服务器响应时, 网卡自动给自己分配一个169.254.x.x/16, 属于全球统一无效地址.

### ipconfig的两个参数

#### ipconfig /release

释放IP(取消租约, 或者改为手动配置IP,也可以释放租约)

#### ipconfig /renew

重新获取IP(有IP时，发送request续约,无IP时发送DIscover包重新获取IP)

### 配置DHCP服务器

#### 一. 创建

配置一台DHCP服务器，并且让客户机可以被分配IP. 

DHCP服务器: win2003

客户机: winxp

1. 让客户机和DHCP服务器连接到同一个网上,配置同一种网卡VMnet1. 这里需要注意的是, 该种网卡需要关掉DHCP服务. 因为如果不关掉DHCP服务,由于连接的类型不同, 如是桥接模式等,可能会让虚拟机的分配的IP是由主机的DHCP服务器分配的,而不是虚拟机中的DHCP服务器提供的．关掉的方法：

   ```
   打开虚拟网配编辑器　－＞　更改设置　－＞　勾掉"使用本地DHCP服务讲IP地址分配给虚拟机"
   ```

2. 给win2003安装DHCP组件, 由于win2003安装的时候,没有默认安装`DHCP`组件，所以需要手动安装，安装方法：

   ```
   点击CD光盘　－＞ 点击"安装可选的windows组件" -> 点击"网络服务" -> 选择"DHCP"
   ```

   这个时候如果win2003没有设置固定的IP地址, 会提示设定固定IP地址. 设置固定IP地址和子网掩码后选择继续.

   这个时候我们使用命令 `netstat -an`可以发现 67/68 端口已经打开了.

3. 这个时候就可以配置DHCP服务了

   ```
   开始 -> 管理工具 -> DHCP -> 选择主机 -> 新建作用域
   ```

   这时候就可以设置 `起始IP地址` 和 `结束IP地址`, 其中长度就是子网掩码二进制长度.

   之后可以设置 `排除`的IP地址, 这种IP地址就是指不会被分到的.

   设置 `租约期限`

   选择是否立即作用, 如果不立即作用, 可以稍后自己激活.

4. 这时候XP有两种方式来获取IP

   ```
   1. 断开再打开网卡
   2. 使用命令 ipconfig /release 和 ipconfig /renew 来重新获取
   ```

#### 二. 保留

假如CEO想要有一个专属的IP地址10.1.1.168，那么`管理工具` -> `DHCP`-> `保留` -> `新建保留` -> `填写CEO的网卡物理地址和需要固定的地址`

那么每次CEO在该局域网下，由DHCP分配的IP地址就是10.1.1.168

注意：不可以手动配置IP，这是因为手动配置IP地址之后，CEO走到其它地方之后，就会上不了网了，因为IP地址被固定了。

#### 三. 备份

给DHCP做备份。

右键主机`备份`->`选择对应的文件夹如：D:\DHCP` ; 这样子D:\DHCP就已经有备份文件了。

对作用域右键`删除`；可以完成对作用域的删除。

右键`还原` -> `选择对应的文件夹D:\DHCP`；就可以对所有作用域进行还原。

#### 四. 地址保留

对指定的MAC地址, 固定动态分配IP地址

#### 五. 作用域选项

当该DHCP服务器管理多个网段时,就需要新建多个作用域.

当我们新建了两个作用域之后, 我们在服务器选项中新建一个DNS服务器的IP地址,那么可以看到这两个作用域中也有这个DNS服务器的IP地址.

作用就是, 我们可以通过设置服务器选项,这样就不用重复的设置作用域选项.

如果一个网段需要另设一个DNS服务器,则可以在它自己的作用于选项中设置DNS服务器的IP地址,会覆盖服务器选项设置的DNS的IP地址．操作手段就是再新建一个DNS服务器，会将原先的覆盖。

作用域选项 **>** 服务器选项

如: 当服务器上有多个作用域时, 可以在服务器选项上设置DNS服务器

### DHCP攻击与服务

1. 攻击DHCP服务器: 频繁发送伪装DHCP请求，知道DHCP地址池耗尽

   防御: 在交换机(管理型) 的端口上做动态MAC地址绑定

2. 伪装DHCP服务器攻击: hack通过讲自己部署为DHCP服务器, 为客户机提供非法IP地址

   防御: 在交换机上(管理型), 除合法的DHCP服务器所在接口外, 全部设置为禁止.