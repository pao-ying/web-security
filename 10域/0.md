## 域

### 基本知识

#### 内网环境

1. 工作组：默认模式，人人平等（不方便统一管理）
2. 域：人人不平等，集中、统一管理

#### 域的特点

集中/统一管理

#### 域的组成：

1. 域控制器：DC(Domain Controller)
2. 成员机

#### 域的部署：

1. 安装域控制器 -- 就生成了域环境
2. 安装活动目录 -- 就生成了域控制器
3. 活动目录： Active Directory（AD）

#### 活动目录

1. AD
2. 特点: 集中管理/统一管理

#### OU: 组织单元

作用: 用于归类域资源(域用户, 域计算机, 域组)

```
前面讲的组和这里的OU作用是一样的,而组的目的是为了赋权限, OU的目的是下发组策略
```

##### 创建OU

1. 打开 AD用户和计算机, 对 qf.com 右键新建组织单位, 定义名字为 qf.

   ```
   可以看到 qf 这个文件夹图标有特殊标识,与Domain Controller的相同.这意味着当在DC上创建组策略表,意味着组策略表是针对于DC的.
   ```

2. 在 qf 下面创建OU分别为 董事会, 市场部, IT部. 同时还可以继续在 市场部 下, 创建新的OU 西北区, 东北区. 

3. 将不同的用户分配在不同的组织单位中, 对 Users 中, 选择 xiaozhuzhu, 右键 所有任务, 点击 移动, 选择 baidu/董事会, 选择将 xiaoyanyan 移动到 baidu/市场部/西北区.一般建议就是 该用户的电脑和该用户放在同一个OU中, 所以同时的，将该用户的电脑也放在相应的OU上．

#### 组策略:GPO

Group Policy

作用:通过组策略可以修改计算机的各种属性, 如开始菜单, 左面背景, 网络参数等.

##### 创建组策略

管理工具中打开组策略管理,  可以看到 组策略 有特殊的图标, 其中qf.com 和 Domain Controller 是有默认组策略的, 也就是这两者都是OU

1. 在OU中右键创建GPO, 命名与OU名称相同.

##### 组策略应用顺序

LSDOU

L: local 就是本地策略

S: 站点, 用于 "林", 用不到

D: 域, 域组策略

OU: 代表一系列OU

在冲突的情况下, 右边权限最高.

##### 创建组策略具体项目

要求整个 qf.com 的桌面都是统一的.

1. 对 qf 组策略右键编辑

   ```
   可以看到计算机管理配置和用户配置, 可以设置该组策略项是跟随着用户的,还是跟随着计算机的.
   ```

2. 在用户配置的策略中管理模块可以看到桌面. 点击桌面, 右边的每一条都是一条策略. 其中状态有三种可能, "未配置"代表组策略不限制, 计算机能有什么操作就进行什么操作. "允许"或"禁止"

3. 在 Active Directory中可以看到桌面墙纸, 点击"已启用", 墙纸名称需要填写路径, 说明:　当这条组策略启用后, 普通用户打开计算机之后就会去DC上下载这个桌面图片, 所以还需要有一个共享文件夹.

4. 在E盘上新建一个共享文件夹share,共享文件名定位 share,  右键属性, 点击共享- 高级共享. 设置完全控制权限. 一般为了保险, 还是会加上 Domian Users. 同样的在属性中的 安全 中也加入 Domain Users. 

5. 回到组策略编辑器, 写下路径 `\\10.1.1.1\share\a.jpg`

6. 理论上说, 用户配置, 用户注销后, 重新登录就可生效. 计算机配置需要电脑重启才会生效.

7. 这个时候可以看到 xiaozhuzhu  和 xiaoyanyan 的电脑都是 a.jpg

8. 在 西北区中 组策略 设置桌面另一张图片  `\\10.1.1.1\share\b.jpg`

9. 西北区的xiaozhuzhu注销后重启桌面就是 b.jpg

**组策略在域中, 是基于OU下发的**





### win2008相关

安装win2008相关服务，右键`计算机` - `管理` - `角色` - `添加角色` - `下一步`就可以看到相关的服务了。

### 活动目录安装与部署

1. 桥接到VMNet2

2. 配置静态IP地址 10.1.1.1/24

3. `开始` - 输入命令 dcpromo，安装活动目录

   1. 安装向导 - 下一步

   2. 提示有差异性，下一步

   3. 勾选为该计算机创建DNS服务，这样该计算机不仅是DNS服务器还是域服务器

   4. 勾选在新林中新建域

      ```
      若有一个域，叫qq.com。同时这个域有一台DC，某个主机叫做my.qq.com。假设有一个上海分公司也想要建立一个子域，且也建立一个DC，那么这个DC就应该叫shagnhai.qq.com，某个主机叫做my.shagnhai.qq.com。若公司业务再一步扩大。创建了一个域叫做wx.com。那么这两个域 wx.com 和 qq.com ，就构成了林。
      ```

      可以看一个链接更好的解释了 [域林与域树](https://www.cnblogs.com/airoot/p/7797731.html)

   5. 输入目录林根级域的FQDN：qf.com

   6. 设置林功能级别，设置了林功能级别，那么以后再设立其它域控制器的林功能级别的版本应该在此之上，不得低于它。选择 win2003

      ```
      所有的林功能级别都是向下兼容的，但是不支持向上兼容。
      ```

   7. 设置域功能级别，勾选2003

      ```
      域功能级别必须大于或等于林功能级别
      ```

   8. 设立活动目录的独立密码，若域控制器出现问题，可以使用改密码进行还原，也成为活动目录的还原密码

4. 登录域 qf \administrator

   ```
   域服务器不在存在本地用户和组了，之前的用户迁移到了活动目录中的表去了。之前的管理员升级为域管理员。
   ```

5. 测验

   1. `计算机属性` ，可以看到域写有 `qf.com`

   2. 管理工具，可以看到DNS和AD服务

      ```
      dns中的正向查找区域可以看到qf.com，自动有 10.1.1.1, 之后有员工登录域，则该列表下就会有该IP地址
      ```

   3. 点开 Active Directory 用户和计算机，这是AD最重要的，也称活动目录。

      ```
      点开qf.com - 
      computers 里面存放的是普通域成员
      Domain Controllers 域控制器（首先该主机就是一个）列表
      Users 域账号
      ```

6. 添加主机进域

   1. winxp 连接 VMnet2, IP 地址设为 10.1.1.2 ，DNS设为10.1.1.1
   2. 右键计算机属性，`更改设置`，计算机名处点击`更改`, 点击域，输入qf.com，输入DC管理员账号: qf.com\Administrator 和 密码
   3. win7不同的就是管理员账号写： Administrator 就可以

7. 在win2008中的AC活动目录中的`computer`可以看到两台主机成功加入域

8. 加进域的主机开机时可以选择是登录本机还是登录域。

   ```
   创建域账号。
   在win2008活动目录中的 users 中创建普通域用户。
   右键 users ,创建用户，设置名zhuzhu，姓xiao。用户登录名zhuzhu.xiao。设立密码。勾掉下次登录时需修改密码。
   这个时候可以在users中看到 xiaozhuzhu 普通域用户。
   winxp登录时下拉菜单选择qf，域登录
   win7登陆时使用其它用户，再使用qf.com/yanyan.xiao登录
   ```

#### 安装问题

1. 加入域不成功

   网络是否通，解析是否能成功，是否为DNS缓存

2. 登入域不成功

   XP,已勾选登录域QF,不用再写QF\zhuzhu.xiao

3. 域用户的权限

   ```
   由于普通域用户登录一个电脑,但是对该电脑没有完全控制权限,但是不能将它提升为域管理员组,所以只能够折中的办法:将域用户加入到普通成员机的本地管理员组中.
   win7为例子,用本地账号登录本机,右键计算机选择管理.点击本地用户和组,选择Administrators组,添加新用户,可以看到此时查找位置是qf.com,输入 yanyan.xiao.这个时候用域普通用户 yanyan.xiao 登录就有该计算机的完全控制权限了.
   ```

4. 了解管理组

   本地管理员组: Administrators

   域管理员组: Domain Admins

